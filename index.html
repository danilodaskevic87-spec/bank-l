<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—É–ø –ë–∞–∑–∞ - –õ—ñ—Å–æ–≤–∞ –ü—ñ—Å–Ω—è</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #010811;
            --card-bg: #05111f;
            --accent-green: #2ecc71;
            --text-white: #ffffff;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-white); margin: 0; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 450px; padding: 20px; box-sizing: border-box; }
        .user-card { background: var(--card-bg); border-radius: 20px; padding: 20px; text-align: center; border: 1px solid #1e2d3d; margin-bottom: 20px; }
        .balance-big { font-size: 36px; font-weight: bold; color: var(--accent-green); margin: 10px 0; }
        .service-btn { width: 100%; border: none; padding: 16px; margin-bottom: 12px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; background-color: var(--accent-green); color: #000; transition: 0.2s; }
        .btn-blue { background-color: #3498db !important; color: white !important; text-decoration: none; }
        .btn-purple { background-color: #9b59b6 !important; color: white !important; }
        .btn-gray { background-color: #34495e !important; color: white !important; }
        .section-header { font-size: 18px; margin: 25px 0 15px; font-weight: bold; border-left: 4px solid var(--accent-green); padding-left: 10px; }
        .hidden { display: none; }
        input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #0a1625; color: white; box-sizing: border-box; }
        .modal { background: rgba(0,0,0,0.9); position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; border: 1px solid var(--accent-green); }
        .request-item { background: #0d1b2a; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #1e2d3d; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen">
        <h2 style="text-align:center">üå≤ –õ—ñ—Å–æ–≤–∞ –ü—ñ—Å–Ω—è</h2>
        <input type="number" id="idd-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à IDD">
        <button class="service-btn" onclick="login()">–£–≤—ñ–π—Ç–∏</button>
    </div>

    <div id="main-app" class="hidden">
        <div class="user-card">
            <div id="user-name" style="font-size: 1.2rem;">...</div>
            <div class="balance-big"><span id="user-balance">0</span> ‚Ç¥</div>
            <div style="color: #8899a6;">IDD: <span id="user-idd">000000</span></div>
        </div>

        <div class="section-header">üí≥ –§—ñ–Ω–∞–Ω—Å–∏</div>
        <a href="https://next.privat24.ua/send/ijak6" target="_blank" class="service-btn btn-blue">‚ûï –ü–æ–ø–æ–≤–Ω–∏—Ç–∏ –±–∞–ª–∞–Ω—Å</a>
        <button class="service-btn btn-purple" onclick="toggleModal('transfer-modal', true)">üì≤ –ó–∞–ø–∏—Ç –Ω–∞ –ø–µ—Ä–µ–∫–∞–∑</button>
        <button class="service-btn btn-gray" onclick="viewTransferRequests()">üì© –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∑–∞–ø–∏—Ç–∏</button>

        <div class="section-header">üçΩÔ∏è –ü–æ—Å–ª—É–≥–∏</div>
        <button class="service-btn" onclick="processOrder('üçî –á–∂–∞', 10)">üçî –á–∂–∞ -10</button>
        <button class="service-btn" onclick="processOrder('üíß –í–æ–¥–∞', 5)">üíß –í–æ–¥–∞ -5</button>
        <button class="service-btn" onclick="processOrder('ü•§ –ö–æ–ª–∞', 12)">ü•§ –ö–æ–ª–∞ -12</button>
        <button class="service-btn" onclick="processOrder('üç¨ –¶—É–∫–µ—Ä–∫–∞', 3)">üç¨ –¶—É–∫–µ—Ä–∫–∞ -3</button>
        <button class="service-btn" onclick="processOrder('üçå –ë–∞–Ω–∞–Ω', 7)">üçå –ë–∞–Ω–∞–Ω -7</button>
        <button class="service-btn" onclick="processOrder('üçä –ú–∞–Ω–¥–∞—Ä–∏–Ω–∏', 8)">üçä –ú–∞–Ω–¥–∞—Ä–∏–Ω–∏ -8</button>

        <div class="section-header">üî• –ö–∞–π—Ñ –∑–æ–Ω–∞ (–í—ñ–ª—å–Ω–∏—Ö: <span id="kz-slots">?</span>)</div>
        <button class="service-btn" onclick="processOrder('ü™ë 1 –º—ñ—Å—Ü–µ', 60)">ü™ë 1 –º—ñ—Å—Ü–µ -60</button>
        <button class="service-btn" onclick="processOrder('üï∂Ô∏è –ö–∞–π—Ñ+', 120)">üï∂Ô∏è –ü–æ—Å–ª—É–≥–∞ -120</button>

        <div class="section-header">üèÜ –°–µ—Ä–≤—ñ—Å–∏</div>
        <button class="service-btn" onclick="processOrder('üíÜ –ú–∞—Å–∞–∂', 150)">üíÜ –ú–∞—Å–∞–∂ -150</button>

        <button class="service-btn btn-gray" style="margin-top: 20px;" onclick="location.reload()">–í–∏–π—Ç–∏</button>
    </div>
</div>

<div id="transfer-modal" class="modal hidden">
    <div class="modal-content">
        <h3>–ó–∞–ø–∏—Ç –Ω–∞ –ø–µ—Ä–µ–∫–∞–∑</h3>
        <input type="number" id="target-idd" placeholder="IDD –æ—Ç—Ä–∏–º—É–≤–∞—á–∞">
        <input type="number" id="transfer-amount" placeholder="–°—É–º–∞">
        <button class="service-btn" onclick="sendTransferRequest()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        <button class="service-btn btn-gray" onclick="toggleModal('transfer-modal', false)">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
</div>

<div id="requests-list-modal" class="modal hidden">
    <div class="modal-content">
        <h3>–í—Ö—ñ–¥–Ω—ñ –∑–∞–ø–∏—Ç–∏</h3>
        <div id="requests-container"></div>
        <button class="service-btn btn-gray" onclick="toggleModal('requests-list-modal', false)">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://mefzopeenhfdqfatbjaq.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_LU94dUJoW2jwZJ9WIdfsMw_lEnMQobx';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let userData = null;

    async function login() {
        const id = document.getElementById('idd-input').value;
        const { data, error } = await supabaseClient.from('bank').select('*').eq('idd', id).single();
        if (data) {
            userData = data;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateUI();
            getKzLimit();
        } else { alert("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!"); }
    }

    function updateUI() {
        document.getElementById('user-name').innerText = userData.name;
        document.getElementById('user-balance').innerText = userData.balance;
        document.getElementById('user-idd').innerText = userData.idd;
    }

    async function getKzLimit() {
        const { data } = await supabaseClient.from('settings').select('value').eq('key', 'kz_limit').single();
        if (data) document.getElementById('kz-slots').innerText = data.value;
    }

    async function processOrder(name, price) {
        if (userData.balance < price) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤!");
        
        const { error } = await supabaseClient.from('bank').update({ balance: userData.balance - price }).eq('idd', userData.idd);
        
        if (!error) {
            await supabaseClient.from('service_requests').insert([{ user_id: userData.user_id, idd: userData.idd, service: name, price: price }]);
            await supabaseClient.from('transactions').insert([{ user_id: userData.user_id, type: 'minus', info: `–û–ø–ª–∞—Ç–∞: ${name}`, amount: price }]);
            
            userData.balance -= price;
            updateUI();
            alert(`–ü–æ—Å–ª—É–≥—É "${name}" —É—Å–ø—ñ—à–Ω–æ —Å–ø–ª–∞—á–µ–Ω–æ!`);
        }
    }

    function toggleModal(id, show) { document.getElementById(id).classList.toggle('hidden', !show); }

    async function sendTransferRequest() {
        const to = document.getElementById('target-idd').value;
        const am = document.getElementById('transfer-amount').value;
        await supabaseClient.from('transfer_requests').insert([{ from_user: userData.user_id, to_idd: parseInt(to), amount: parseFloat(am), status: 'pending' }]);
        alert("–ó–∞–ø–∏—Ç –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!");
        toggleModal('transfer-modal', false);
    }

    async function viewTransferRequests() {
        const { data } = await supabaseClient.from('transfer_requests').select('*').eq('to_idd', userData.idd).eq('status', 'pending');
        const cont = document.getElementById('requests-container');
        cont.innerHTML = data?.length ? '' : '–ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤';
        data?.forEach(req => {
            const div = document.createElement('div');
            div.className = 'request-item';
            div.innerHTML = `–°–ø–∏—Å–∞—Ç–∏: ${req.amount} ‚Ç¥ <button class="service-btn" onclick="confirmTransfer(${req.id}, ${req.amount})">OK</button>`;
            cont.appendChild(div);
        });
        toggleModal('requests-list-modal', true);
    }

    async function confirmTransfer(reqId, amount) {
        if (userData.balance < amount) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≥—Ä–æ—à–µ–π!");
        await supabaseClient.from('bank').update({ balance: userData.balance - amount }).eq('idd', userData.idd);
        await supabaseClient.from('transfer_requests').update({ status: 'success' }).eq('id', reqId);
        alert("–ì—Ä–æ—à—ñ –ø–µ—Ä–µ–∫–∞–∑–∞–Ω–æ!");
        location.reload();
    }
</script>
</body>
</html>
